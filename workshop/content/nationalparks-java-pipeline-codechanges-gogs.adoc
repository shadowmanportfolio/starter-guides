== 背景：Web Hooks

大多数Git存储库服务器支持web hooks的概念——当代码存储库发生变化时，通过HTTP(S)调用触发外部事件。OpenShift提供了一个API端点，支持从远程系统接收hook以触发构建。通过将代码库的hook指向OpenShift pipeline（管道）资源，可以实现自动化的代码/构建/部署管道。

== 向管道添加触发器

Tekton *Triggers* 使我们能够配置Pipeline来响应外部事件(Git push events, pull requests 等等)，比如Web Hooks。

添加触发支持需要在我们的项目中创建一个 `TriggerTemplate`、 `TriggerBinding`和一个 `EventListener` 。



image::images/devops-pipeline-triggers.png[Triggers]

让我们详细看看每个组件：

* *TriggerTemplate*：触发器模板是新创建资源的模板。它支持参数来创建特定的 `PipelineResources` 和 `PipelineRuns` 。
* *TriggerBinding*：验证事件并提取有效负载字段。
* *EventListener*: 将 `TriggerBindings` 和 `TriggerTemplates` 连接到可寻址端点(事件接收器)。它使用从每个TriggerBinding(和任何提供的静态参数)提取的事件参数来创建相应的TriggerTemplate中指定的资源。它还允许外部服务通过拦截器字段对事件有效负载进行预处理。

现在让我们为我们的Pipeline一起创建它们：

[source,shell,role=execute-1]
----
oc create -f http://gogs-{{INFRA_PROJECT}}.{{cluster_subdomain}}/{{username}}/nationalparks/raw/master/pipeline/nationalparks-triggers.yaml -n {{project_namespace}}
----

这将创建一个带有路由的新Pod，我们可以使用它在Gogs上设置我们的Webhook来触发管道的自动启动。

在左侧菜单中，点击 *Topology* 以验证是否为 `EventListener` 创建了一个新的Deployment *el-nationalparks* ：

image::images/devops-pipeline-triggers-eventlistener.png[EventListener created]


== 练习：配置Gogs Web Hooks

点击部署，进入 *Routes* 部分并复制 *el-nationparks* 路由 URL。

image::images/devops-pipeline-triggers-route.png[EventListener created]

一旦你把URL复制到剪贴板上，导航到Gogs上的代码库：


link:http://gogs-{{INFRA_PROJECT}}.{{cluster_subdomain}}/{{username}}/nationalparks[Gogs Repository]


Your Gogs credentials are:

[source,bash]
----
username: {{username}}
password: {{GOGS_PASSWORD}}
----

Click the Settings link on the top right of the screen:

image::images/nationalparks-codechanges-gogs-settings.png[Webhook]

Click on *Webhooks*, then the *Add Webhook* button, and finally select *Gogs*.

image::images/nationalparks-codechanges-gogs-add-webhook.png[Webhook]

In the next screen, paste your link into the "Payload URL" field. You can leave the
secret token field blank -- the secret is already in the URL and does not need
to be in the payload.

Change the `Content Type` to `application/json`.

Finally, click on *Add Webhook*.

image::images/nationalparks-codechanges-gogs-config-webhook.png[Webhook]

Boom! From now on, every time you commit new source code to your Gogs
repository, a new build and deploy will occur inside of OpenShift.  Let's try
this out.

== Exercise: Using Gogs Web Hooks
Click the *Files* tab in Gogs. This is Gogs's repository view.  

CAUTION: Make sure that the drop-down menu at the upper right is set for 
the *`master`* branch. Navigate to the
following path:

[source,bash]
----
src/main/java/com/openshift/evg/roadshow/parks/rest/
----

Then click on the `BackendController.java` file.

Once you have the file on the screen, click the edit button in the top right
hand corner as shown here:

image::images/nationalparks-codechanges-gogs-change-code.png[Webhook]

Change line number 20:

[source,java]
----
return new Backend("nationalparks","National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

To

[source,java]
----
return new Backend("nationalparks","Amazing National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

Click on Commit changes at the bottom of the screen. Feel free to enter a commit
message.

Once you have committed your changes, a new *PipelineRun* should almost instantaneously be
triggered in OpenShift. Click *Pipeline* in the left navigation menu then `nationalparks-pipeline`. You should see a new one running: 

image::images/nationalparks-codechanges-pipeline-running.png[Webhook]

or run the following command to verify:

[source,bash,role=execute-1]
----
oc get PipelineRun
----

Once the build and deploy has finished, verify your new image was automatically deployed by viewing the application in your browser:


link:http://nationalparks-{{project_namespace}}.{{cluster_subdomain}}/ws/info/[National Parks Info Page]


You should now see the new name you have set in the JSON string returned.

NOTE: To see this in the map's legend itself, you will need to scale down your parksmap to 0, then back up to 1 to force the app to refresh its cache.

