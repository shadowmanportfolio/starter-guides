== JBoss EAP 集群

JBoss EAP中的集群是使用Kubernetes发现机制通过找到其他JBoss EAP容器并形成一个集群实现。具体是配置JGroups协议栈 `standalone-openshift.xml` 文件中的 `<openshift.KUBE_PING/>` 配置项.

为了让 `KUBE_PING` 工作，必须采取以下步骤：

. 必须设置 `OPENSHIFT_KUBE_PING_NAMESPACE` 环境变量。否则，服务器将成为一个单节点集群。
. 应该设置 `OPENSHIFT_KUBE_PING_LABELS` 环境变量。否则，应用程序之外的Pod(在您的名称空间中)将尝试加入集群。
. 必须将授权授予运行pod的服务帐户允许访问Kubernetes的REST api.

在先前的实验中，您已经配置了默认服务帐户可以访问 Kubernetes的REST API。现在您可以通过单击控制台上的箭头将 *mlbparks* Pod扩展到2。另外,您可以使用命令行扩展Pod并形成两个成员的集群。

[source,bash,role=copypaste]
----
oc scale dc/mlbparks --replicas=2
----

For pods based on Java images, the web console also exposes access to a
hawt.io-based JVM console for viewing and managing any relevant Java components.
A link is displayed in the pod's details on the *Workloads -> Pods* page,
provided the container has a port named jolokia. On the console, click on
mlbparks pods, then on any of the two pods deployed. On the *Details* tab, click
on *Open Java Console*.对于基于Java镜像的Pod，web控制台还公开了基于hawt.io，查看和管理任何相关Java组件的JVM控制台。
一个链接显示在 *Workloads -> Pods* 页面的pod详细信息，前提是容器开放了个叫jolokia的端口。在控制台上，单击
Mlbparks pod，然后在两个pod中的任何一个上部署。在“*Details*”页签中，单击
打开Java控制台*。

image::images/mlbparks-clustering-details.png[Java Console Link,880,align="center"]

In the Java Console, use the *JMX* browser and click on *jgroups &rarr; channel
&rarr; ee*. The right pane shows the list of clustering JMX attributes including
*view* which is the current state of the cluster. This attribute shows the name
of two pods which are currently members of the cluster. When *mlbparks* pod gets
scaled up or down, JBoss EAP gets notified by calling Kubernetes' REST API and
updates the cluster status based on the number of pods available.

image::images/mlbparks-clustering-hawtio.png[Java Console - Clustering,1000,align="center"]

// TODO: add stateful (session, cache, etc) data to the mlbparks backend.
